<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>가위바위보</title>
    <style>
      body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding-top: 20vh;
      }
      #computer {
        width: 142px;
        height: 200px;
      }
      #buttons {
        margin: 20px 0;
        display: flex;
        width: 142px;
        justify-content: space-between;
        align-items: center;
      }
      #buttons button {
        width: 40px;
      }
      #scoreDiv {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 142px;
      }
      .score {
        flex: 1;
        border: 1px solid black;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #log {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 200px;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div id="computer"></div>
    <div id="buttons">
      <button id="scissors" class="btn">가위</button>
      <button id="rock" class="btn">바위</button>
      <button id="paper" class="btn">보</button>
    </div>
    <div id="scoreDiv">
      <div class="score">점수</div>
      <div id="myScore" class="score">0</div>
      <div id="computerScore" class="score">0</div>
    </div>
    <div id="log"></div>

    <script>
      const $computer = document.querySelector("#computer");
      const $scissors = document.querySelector("#scissors");
      const $rock = document.querySelector("#rock");
      const $paper = document.querySelector("#paper");
      const $btn = document.querySelectorAll(".btn");
      const $myScore = document.querySelector("#myScore");
      const $computerScore = document.querySelector("#computerScore");
      const $log = document.querySelector("#log");

      const IMG_URL = "./images/rsp.png";
      $computer.style.background = `url(${IMG_URL}) 0 0`;
      $computer.style.backgroundSize = "auto 200px";

      const rspX = {
        scissors: "0",
        rock: "-220px",
        paper: "-440px",
      };

      let coord = "scissors";
      let myScore = 0;
      let computerScore = 0;
      let interval;
      let isEnd = false;

      async function handleClick(e) {
        controlBtns(true);
        stopRSP();
        calc(e.currentTarget.id);
        await setTimeoutPromise(1000);
        startRSP();
        controlBtns(false);
      }

      function startRSP() {
        interval = setInterval(() => {
          if (coord == "scissors") {
            coord = "rock";
          } else if (coord == "rock") {
            coord = "paper";
          } else if (coord == "paper") {
            coord = "scissors";
          }
          $computer.style.background = `url(${IMG_URL}) ${rspX[coord]} 0`;
          $computer.style.backgroundSize = "auto 200px";
        }, 55);
      }

      async function stopRSP() {
        clearInterval(interval);
        await setTimeoutPromise(0);
      }

      function calc(my) {
        const rspWin = {
          scissors: "paper",
          paper: "rock",
          rock: "scissors",
        };
        let result = "무승부";

        if (rspWin[my] == coord) {
          myScore++;
          result = "승";
          $myScore.textContent = myScore;
        }
        if (rspWin[coord] == my) {
          computerScore++;
          result = "패";
          $computerScore.textContent = computerScore;
        }

        if (myScore == 3) {
          result = "축하합니다 승리하셨습니다.";
          isEnd = true;
        }
        if (computerScore == 3) {
          result = "아쉽게도 패배하셨습니다.";
          isEnd = true;
        }

        $log.textContent = result;
      }

      const extractNumber = (x) => Number(String(x).match(/-?\d+/)?.[0]);

      const setTimeoutPromise = (ms) =>
        new Promise((resolve) => setTimeout(resolve, ms));

      const controlBtns = (state) => {
        if (!isEnd) {
          $btn.forEach((btn) => {
            btn.disabled = state;
          });
        } else {
          stopRSP();
        }
      };

      $btn.forEach((btn) => {
        btn.addEventListener("click", handleClick);
      });

      startRSP();
    </script>
  </body>
</html>
